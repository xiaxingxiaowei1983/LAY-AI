<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotelVest - 智能投资顾问</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a365d',
                        secondary: '#f8f5f0',
                        accent: '#e6a23c',
                        neutral: '#f5f5f5',
                        'neutral-dark': '#333333',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bg-pattern {
                background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
                background-size: 20px 20px;
            }
            .shadow-soft {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }
        }
    </style>
</head>
<body class="bg-neutral font-sans text-neutral-dark">
    <div class="flex min-h-screen">
        <!-- 左侧导航栏 -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <!-- Logo区域 -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg overflow-hidden">
                        <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-primary">LAY AI</h1>
                        <p class="text-xs text-gray-500">酒店投资风控参谋</p>
                    </div>
                </div>
            </div>

            

            <!-- 会话管理 -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="space-y-3">
                    <button class="w-full flex items-center space-x-3 px-4 py-3 bg-secondary rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fa fa-plus text-gray-500"></i>
                        <span class="text-sm font-medium">发起新咨询</span>
                    </button>
                    <button class="w-full flex items-center space-x-3 px-4 py-3 bg-primary bg-opacity-10 rounded-lg text-primary font-medium">
                        <i class="fa fa-file-text-o"></i>
                        <span class="text-sm">当前底稿生成</span>
                    </button>
                    <button class="w-full flex items-center space-x-3 px-4 py-3 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fa fa-folder-open text-gray-500"></i>
                        <span class="text-sm">过往投资案</span>
                    </button>
                </div>
            </div>

            <!-- 用户信息 -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold">
                        JS
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">Jason</p>
                        <p class="text-xs text-gray-500">酒店准业主</p>
                    </div>
                    <button class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fa fa-chevron-down"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- 右侧主内容区 -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部标题栏 -->
            <header class="bg-white border-b border-gray-200 p-6">
                <div class="flex justify-between items-center">
                    <div>
                        
                    </div>
                    <div class="flex items-center space-x-3">
                        <button class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center space-x-2">
                            <i class="fa fa-share-alt text-gray-600"></i>
                            <span class="text-sm">分享底稿</span>
                        </button>
                        <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center space-x-2">
                            <i class="fa fa-file-pdf-o"></i>
                            <span class="text-sm">导出完整PDF</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- 主要内容 -->
            <div class="flex-1 overflow-y-auto p-8 bg-pattern">
                <div class="max-w-3xl mx-auto space-y-8">
                    

                    

                    <!-- 聊天历史 -->
                    <div id="chat-history" class="space-y-6">
                        <!-- 消息将通过 JavaScript 动态添加 -->
                    </div>
                </div>
            </div>

            <!-- 输入区域 -->
            <footer class="bg-white border-t border-gray-200 p-4">
                <div class="max-w-3xl mx-auto">
                    <div class="mb-2">
                        <p class="text-xs text-gray-400 text-center">LAY AI 生成的观点仅供决策参考，投资有风险，入局需谨慎。</p>
                    </div>
                    <form id="chat-form" class="flex items-center space-x-3">
                        <div class="flex-1 relative">
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                <i class="fa fa-plus-circle"></i>
                            </div>
                            <input 
                                type="text" 
                                id="user-input" 
                                placeholder="输入城市+物业情况，例如：'我想在杭州西湖边租个老别墅做民宿，房东报价很低...'" 
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            >
                        </div>
                        <button 
                            type="submit" 
                            class="w-10 h-10 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center"
                        >
                            <i class="fa fa-arrow-up"></i>
                        </button>
                    </form>
                </div>
            </footer>
        </main>
    </div>



    <script>
        // 调用本地代理服务器API
        async function callAliAPI(prompt) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt
                    })
                });
                
                if (!response.ok) {
                    console.error('API调用失败:', response.status, await response.text());
                    return null;
                }
                
                const data = await response.json();
                return {
                    output: {
                        text: data.text
                    }
                };
            } catch (error) {
                console.error('API调用失败:', error);
                return null;
            }
        }

        // 应用状态管理
        class LayAIBackend {
            constructor() {
                this.state = "IDLE";
                this.history = [];
            }

            async getResponse(userInput) {
                // 状态机逻辑
                const currentState = this.state;
                
                // 1. IDLE -> DIAGNOSTIC (智商税测试启动)
                if (currentState === "IDLE") {
                    this.state = "DIAGNOSTIC_WAITING";
                    
                    // 调用阿里API获取欢迎消息
                    const prompt = "你是LAY，一个理性、专业、冷静、一针见血的酒店投资风控参谋。请用中文欢迎用户Jason，介绍你的身份和功能，强调你能通过直指商业底层本质来帮助用户避免投资陷阱，挽救用户的钱包。";
                    const apiResponse = await callAliAPI(prompt);
                    
                    let content = "正在获取AI响应...";
                    
                    if (apiResponse && apiResponse.output) {
                        content = apiResponse.output.text || content;
                    }
                    
                    return `
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg overflow-hidden">
                                    <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="bg-white rounded-xl p-5 shadow-soft">
                                    <p class="text-gray-700">${content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // 2. DIAGNOSTIC -> ANALYSIS (测试反馈与分析)
                else if (currentState === "DIAGNOSTIC_WAITING") {
                    const input = userInput.toUpperCase();
                    if (!["A", "B", "C"].includes(input)) {
                        // 调用阿里API获取提示消息
                        const prompt = "你是LAY，一个理性、专业、冷静、一针见血的酒店投资风控参谋。用户输入了无效选项，不是A、B、C中的一个。请用中文提示用户必须选择A、B或C，并强调这很重要，因为跳过或随意填写会直接导致风控诊断失效，浪费时间和资金。";
                        const apiResponse = await callAliAPI(prompt);
                        
                        let content = "正在获取AI响应...";
                        
                        if (apiResponse && apiResponse.output) {
                            content = apiResponse.output.text || content;
                        }
                        
                        return `
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 rounded-lg overflow-hidden">
                                        <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="bg-white rounded-xl p-5 shadow-soft">
                                        <p class="text-gray-700">${content}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 调用阿里API获取测试反馈
                    const prompt = `用户在智商税测试中选择了${input}。请作为LAY，一个理性、专业、冷静、一针见血的酒店投资风控参谋，给出测试反馈，直指商业底层本质，然后引导用户提供具体的投资意向（城市、预算、酒店类型）。`;
                    const apiResponse = await callAliAPI(prompt);
                    
                    let response = "";
                    
                    if (apiResponse && apiResponse.output) {
                        response = `<p class='text-gray-700'>${apiResponse.output.text}</p>`;
                    } else {
                        // API调用失败时的默认消息
                        response = "<p class='text-gray-700'>测试反馈获取失败，请稍后重试。</p>";
                    }
                    
                    this.state = "ANALYSIS";
                    
                    return `
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg overflow-hidden">
                                    <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="bg-white rounded-xl p-5 shadow-soft">
                                    ${response}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // 3. ANALYSIS -> GENERATING (城市路由与生成)
                else if (currentState === "ANALYSIS") {
                    const city = this.extractCity(userInput);
                    const tier = this.getCityTier(city);
                    const templateType = tier === "Tier1" ? "【一线城市高周转模板】" : "【通用生存模板】";
                    
                    this.state = "GENERATING";
                    
                    // 调用阿里API获取城市分析
                    const prompt = `用户想在${userInput}投资酒店。请作为LAY，一个理性、专业、冷静、一针见血的酒店投资风控参谋，分析该城市的酒店市场，直指商业底层本质，提供专业的投资建议，强调风险控制，挽救用户的钱包。`;
                    const apiResponse = await callAliAPI(prompt);
                    
                    let analysisContent = "正在分析城市数据...";
                    
                    if (apiResponse && apiResponse.output) {
                        analysisContent = apiResponse.output.text || analysisContent;
                    }
                    
                    return `
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg overflow-hidden">
                                    <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="bg-white rounded-xl p-5 shadow-soft">
                                    <p class="text-gray-700">${analysisContent}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // 4. PAUSED -> RESUMED (断点续写)
                else if (currentState === "GENERATING") {
                    // 调用阿里API获取财务测算
                    const prompt = "用户要求继续查看财务测算表。请作为LAY，一个理性、专业、冷静、一针见血的酒店投资风控参谋，提供详细的财务测算和风险分析，直指商业底层本质，强调投资风险和风控措施，挽救用户的钱包。";
                    const apiResponse = await callAliAPI(prompt);
                    
                    let content = "正在获取AI响应...";
                    
                    if (apiResponse && apiResponse.output) {
                        content = apiResponse.output.text || content;
                    }
                    
                    return `
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg overflow-hidden">
                                    <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="bg-white rounded-xl p-5 shadow-soft">
                                    <p class="text-gray-700">${content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // 调用阿里API获取系统异常消息
                const prompt = "你是LAY，一个理性、专业、冷静、一针见血的酒店投资风控参谋。系统遇到异常情况。请用中文提示用户系统出现异常，并建议刷新页面重试，保持你的专业、冷静的风格。";
                const apiResponse = await callAliAPI(prompt);
                
                let content = "正在获取AI响应...";
                
                if (apiResponse && apiResponse.output) {
                    content = apiResponse.output.text || content;
                }
                
                return `
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-lg overflow-hidden">
                                <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="bg-white rounded-xl p-5 shadow-soft">
                                <p class="text-gray-700">${content}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            extractCity(text) {
                if (text.includes("北京") || text.includes("上海")) return "上海";
                if (text.includes("长沙")) return "长沙";
                return "未知城市";
            }

            getCityTier(city) {
                const tier1 = ["北京", "上海", "广州", "深圳"];
                if (tier1.includes(city)) return "Tier1";
                return "General";
            }

            addMessage(role, content) {
                this.history.push({ role, content });
            }
        }

        // 初始化应用
        const backend = new LayAIBackend();
        const chatHistory = document.getElementById('chat-history');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');

        // 添加消息到界面
        function addMessageToUI(role, content) {
            if (role === 'user') {
                const userMessage = `
                    <div class="flex items-start justify-end space-x-4">
                        <div class="flex-1 max-w-[70%]">
                            <div class="bg-primary rounded-xl p-5 shadow-soft">
                                <p class="text-white">${content}</p>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold">
                                JS
                            </div>
                        </div>
                    </div>
                `;
                chatHistory.insertAdjacentHTML('beforeend', userMessage);
            } else {
                chatHistory.insertAdjacentHTML('beforeend', content);
            }
            // 滚动到底部
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // 显示加载状态
        function showLoading() {
            const loadingMessage = `
                <div id="loading-message" class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-lg overflow-hidden">
                            <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="bg-white rounded-xl p-5 shadow-soft">
                            <p class="text-gray-500">(正在分析...)</p>
                        </div>
                    </div>
                </div>
            `;
            chatHistory.insertAdjacentHTML('beforeend', loadingMessage);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // 移除加载状态
        function removeLoading() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // 初始化欢迎消息
        async function initWelcomeMessage() {
            try {
                const welcomeMessage = await backend.getResponse("");
                addMessageToUI('assistant', welcomeMessage);
            } catch (error) {
                console.error('初始化消息失败:', error);
                const defaultMessage = `
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-lg overflow-hidden">
                                <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="bg-white rounded-xl p-5 shadow-soft">
                                <p class="text-gray-700">系统初始化失败，请稍后重试。</p>
                            </div>
                        </div>
                    </div>
                `;
                addMessageToUI('assistant', defaultMessage);
            }
        }

        // 处理表单提交
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const input = userInput.value.trim();
            if (!input) return;

            // 添加用户消息
            addMessageToUI('user', input);
            backend.addMessage('user', input);
            userInput.value = '';

            // 显示加载状态
            showLoading();

            try {
                // 调用异步方法获取响应
                const response = await backend.getResponse(input);
                removeLoading();
                addMessageToUI('assistant', response);
                backend.addMessage('assistant', response);
            } catch (error) {
                console.error('获取响应失败:', error);
                removeLoading();
                // 调用阿里API获取错误提示消息
                const prompt = "你是LAY，一个理性、专业、冷静、一针见血的酒店投资风控参谋。系统API调用失败，请用中文提示用户稍后重试，并保持你的专业、冷静的风格。";
                callAliAPI(prompt).then(apiResponse => {
                    let content = "正在获取AI响应...";
                    
                    if (apiResponse && apiResponse.output) {
                        content = apiResponse.output.text || content;
                    }
                    
                    const errorMessage = `
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg overflow-hidden">
                                    <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="bg-white rounded-xl p-5 shadow-soft">
                                    <p class="text-gray-700">${content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    addMessageToUI('assistant', errorMessage);
                }).catch(() => {
                    // 如果API调用也失败，显示最简单的错误提示
                    const errorMessage = `
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg overflow-hidden">
                                    <img src="/LAY.jpg" alt="LAY AI" class="w-full h-full object-cover">
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="bg-white rounded-xl p-5 shadow-soft">
                                    <p class="text-gray-700">系统异常，请稍后重试。</p>
                                </div>
                            </div>
                        </div>
                    `;
                    addMessageToUI('assistant', errorMessage);
                });
            }
        });



        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 不自动调用大模型生成欢迎消息，让用户自己调用
        });
    </script>
</body>
</html>